# Что такое нормализация данных
Нормализация — это способ упорядочить данные в базе так, чтобы исключить дублирование и упростить работу с таблицами. Смысл нормализации — разложить информацию по связанным таблицам так, чтобы каждая единица данных хранилась в одном месте. Это помогает экономить память и ускоряет поиск, обновление или удаление данных.

Чтобы добиться этого, таблицы делят на логические блоки и соединяют их с помощью ключей — уникальных столбцов, по которым можно связать данные между таблицами. Например, вместо того чтобы повторять одно и то же имя покупателя в каждой строке таблицы заказов, мы выносим его в отдельную таблицу `users`, а в заказах (`orders`) просто указываем `user_id`.

**Основные понятия**

**Атрибут** — характеристика или параметр объекта, часто совпадает с понятием "поле" в таблице базы данных.

**Область значений атрибута (домен)** — набор допустимых значений, которые может принимать конкретный атрибут.

**Кортеж** — упорядоченный набор взаимосвязанных значений атрибутов, описывающий один экземпляр сущности. В терминах таблиц — это одна строка.

**Отношение** — совокупность всех кортежей, представляющая собой таблицу как структуру данных.

**Схема отношения** — определённый набор атрибутов, задающий структуру таблицы. По сути, это описание полей, из которых формируется таблица.

**Проекция** — результат выборки из отношения с исключением или перестановкой некоторых атрибутов. Это новый набор данных, сформированный на основе исходной таблицы.

**Функциональная зависимость** между X и Y означает следующее: если в двух строках таблицы значения X совпадают, то значения Y также будут одинаковыми. Например, если «Название компании» — это Canonical Ltd, то «Штаб-квартира» всегда будет Millbank Tower, London, United Kingdom. Обозначается как: {X} → {Y}.

**Нормальная форма** — это формализованное требование к структуре таблиц, применяемое для исключения избыточных функциональных зависимостей между полями.

**Нормализация** — методика, при которой сначала собирается вся информация о предметной области в одной таблице, а затем происходит её разбиение (декомпозиция) на несколько взаимосвязанных таблиц, исходя из правил нормальных форм.

**Цель нормализации** — устранение избыточных повторов в данных, которые могут вызывать ошибки при вставке, изменении или удалении строк в таблице.

**Аномалия** — состояние базы данных, при котором возникает логическое несоответствие или затруднение при обработке данных, чаще всего вызванное повторяющейся или дублирующейся информацией.

**Аномалии обновления** — при изменении одного значения может потребоваться корректировка всех других строк, где оно повторяется.

**Аномалии удаления** — удаление одной строки может привести к потере данных, не напрямую связанных с этой записью.

**Аномалии добавления** — ситуация, когда невозможно внести новую информацию, не нарушив структуру таблицы, либо приходится обращаться к другим строкам, чтобы корректно добавить запись.

### Первая нормальная форма (1НФ)

Отношение считается приведённым к первой нормальной форме, если каждый из его атрибутов содержит только неделимые (простые) значения. Иными словами, домены всех атрибутов должны включать исключительно скалярные значения — без вложенных списков, множеств или структур. Кроме того, строки таблицы не должны дублироваться.

Таким образом, чтобы соответствовать 1НФ:
- все поля содержат только атомарные данные;
    
- каждый столбец — однотипный;
    
- все записи (кортежи) уникальны.

рассмотрим таблицу с данными о кошках:
```
|Питомник|Породы|
|---|---|
|КотоДом|Сфинкс, Мейн-кун, Абиссинская|
|Мурзик&Ко|Британская короткошёрстная|
```
В данной таблице нарушается первая нормальная форма: у питомника «КотоДом» в одной ячейке указано сразу несколько пород, т.е. значение атрибута не является атомарным (простым).

**Приведение таблицы к 1НФ**

Чтобы соблюсти требования 1НФ, необходимо разнести каждую породу в отдельную строку:
```
|Питомник|Порода|
|---|---|
|КотоДом|Сфинкс|
|КотоДом|Мейн-кун|
|КотоДом|Абиссинская|
|Мурзик&Ко|Британская короткошёрстная|
```
Теперь каждая ячейка содержит только одно значение, и таблица соответствует первой нормальной форме.

### Вторая нормальная форма (2НФ)

Отношение удовлетворяет второй нормальной форме, если оно:
- уже приведено к первой нормальной форме (1НФ),
    
- и каждый неключевой атрибут полностью зависит от всего первичного ключа, а не от его части.

**Полная функциональная зависимость** означает, что невозможно выделить подмножество атрибутов из ключа, от которого отдельно зависит неключевой атрибут. Если такая зависимость существует — это нарушение 2НФ.

Представим таблицу, содержащую информацию о кошках в разных питомниках:
```
|Порода|Питомник|Цена|Скидка|
|---|---|---|---|
|Сфинкс|КотоДом|100000|10%|
|Мейн-кун|КотоДом|120000|10%|
|Абиссинская|КотоДом|110000|10%|
|Британская короткош.|Мурзик&Ко|90000|5%|
```
Первичный ключ в этом случае — сочетание атрибутов **Порода + Питомник**, поскольку одной и той же породы могут быть кошки в разных питомниках с разной ценой.

Но атрибут **Скидка** зависит только от **Питомника**, а не от полной комбинации ключа. Это говорит о **неполной функциональной зависимости**, следовательно, таблица не находится во 2НФ.

**Приведение к 2НФ:**

Декомпозируем исходную таблицу на две:
1. Основная информация о кошках:
```
|Порода|Питомник|Цена|
|---|---|---|
|Сфинкс|КотоДом|100000|
|Мейн-кун|КотоДом|120000|
|Абиссинская|КотоДом|110000|
|Британская короткош.|Мурзик&Ко|90000|
```
2. Таблица скидок по питомникам:
```
|Питомник|Скидка|
|---|---|
|КотоДом|10%|
|Мурзик&Ко|5%|
```
Теперь все неключевые атрибуты зависят от полного первичного ключа, и отношения удовлетворяют требованиям второй нормальной формы.

### Третья нормальная форма (3НФ)

Отношение считается приведённым к третьей нормальной форме, если оно:
- уже удовлетворяет требованиям второй нормальной формы (2НФ),
    
- и при этом **все неключевые атрибуты напрямую (а не транзитивно) зависят от первичного ключа**.

Проще говоря, в таблице не должно быть таких ситуаций, когда один неключевой столбец зависит от другого неключевого столбца, который в свою очередь зависит от ключа. Такие опосредованные (транзитивные) зависимости следует устранять, вынося связанные данные в отдельные таблицы.

Предположим, у нас есть следующая таблица:
```
|Порода|Питомник|Телефон|
|---|---|---|
|Сфинкс|КотоДом|55-11-22|
|Мейн-кун|КотоДом|55-11-22|
|Бенгальская|Мурзик&Ко|88-99-77|
```
Первичным ключом здесь является атрибут **Порода** (в каждой строке указана уникальная порода).

Таблица соответствует 2НФ, потому что:
- каждый неключевой атрибут (Питомник и Телефон) зависит от полного ключа — породы.

Однако при этом существует **транзитивная зависимость**:
- Порода → Питомник,
    
- Питомник → Телефон,
    
- следовательно, Порода → Телефон — **транзитивно**.

Это нарушает условия 3НФ, потому что атрибут **Телефон** зависит не от ключа напрямую, а через другой неключевой атрибут — **Питомник**.

**Приведение к 3НФ:**

Разделим данные на два логически связанных отношения:
1. Таблица питомников и их контактов:
```
|Питомник|Телефон|
|---|---|
|КотоДом|55-11-22|
|Мурзик&Ко|88-99-77|
```
2. Таблица пород и питомников:
```
|Порода|Питомник|
|---|---|
|Сфинкс|КотоДом|
|Мейн-кун|КотоДом|
|Бенгальская|Мурзик&Ко|
```
Теперь в каждой из таблиц отсутствуют транзитивные зависимости: все неключевые атрибуты зависят только от своих первичных ключей напрямую. Отношения приведены к третьей нормальной форме.

### Нормальная форма Бойса–Кодда (НФБК)

**НФБК** — это более строгая версия третьей нормальной формы. Она применяется в ситуациях, когда в отношении:
1. существует два и более потенциальных ключа;
    
2. эти ключи являются составными (состоят из нескольких атрибутов);
    
3. ключи пересекаются — имеют хотя бы один общий атрибут.

Если в таблице только один потенциальный (первичный) ключ, то приведение к НФБК фактически совпадает с 3НФ.

**Условие НФБК:**  
Отношение находится в нормальной форме Бойса–Кодда, если для **каждой нетривиальной и неприводимой** функциональной зависимости левый атрибут (детерминант) — это потенциальный ключ.

Рассмотрим таблицу бронирования визитов к кошкам в выставочном центре:
```
|Имя кошки|Время начала|Время окончания|Уровень допуска|
|---|---|---|---|
|Муся|10:00|11:00|VIP|
|Муся|12:00|13:00|VIP|
|Рыжик|10:30|11:30|Стандарт|
|Рыжик|12:30|13:30|Стандарт|
|Мурка|14:00|15:30|Гость|
```
Допустим, **уровень допуска** определяет, к каким кошкам можно записаться и зависит от:
- породы,
    
- наличия членства в клубе.

То есть:
- **VIP** — только для членов клуба и только к кошке «Муся»;
    
- **Стандарт** — доступен всем, кто хочет посетить «Рыжика»;
    
- **Гость** — свободный вход, например, к «Мурке».

Получается, что:
- возможны несколько потенциальных ключей, например: {Имя кошки, Время начала}, {Имя кошки, Время окончания}, {Уровень допуска, Время начала} и т.д.;
    
- все атрибуты входят в потенциальные ключи — формально 3НФ соблюдается;
    
- **но** присутствует зависимость: `Уровень допуска → Имя кошки`, а **уровень допуска** не является потенциальным ключом.

Это означает, что отношение **не соответствует нормальной форме Бойса–Кодда**, несмотря на соблюдение 3НФ.

**Проблема**: из-за текущей структуры можно по ошибке присвоить уровень доступа «VIP» кошке, к которой он не относится. Это нарушит целостность данных.

**Приведение к НФБК:**

Разделим таблицу на две, введя атрибут **Есть членство**:
1. **Таблица доступа (Уровни доступа):**
```
|Уровень допуска|Имя кошки|Есть членство|
|---|---|---|
|VIP|Муся|Да|
|Стандарт|Рыжик|Нет|
|Гость|Мурка|Нет|
```
2. Таблица записей (Визиты):
```
|Уровень допуска|Время начала|Время окончания|
|---|---|---|
|VIP|10:00|11:00|
|VIP|12:00|13:00|
|Стандарт|10:30|11:30|
|Стандарт|12:30|13:30|
|Гость|14:00|15:30|
```
Теперь:
- каждая зависимость в таблице использует потенциальный ключ как детерминант,
    
- нельзя приписать «VIP» к Мурке — такая комбинация отсутствует в таблице доступа,
    
- структура соответствует требованиям **НФБК**.

### Четвёртая нормальная форма (4НФ)

Отношение находится в **4НФ**, если оно:
- уже в **нормальной форме Бойса-Кодда (НФБК)**;
    
- и **не содержит нетривиальных многозначных зависимостей**, кроме тех, что определяются потенциальными ключами.

Допустим, кошки в приюте могут:
- есть разные виды корма;
    
- жить в разных комнатах.
```
|Кошка|Вид корма|Комната|
|---|---|---|
|Муся|Влажный|Комната 1|
|Муся|Сухой|Комната 1|
|Муся|Влажный|Комната 2|
|Муся|Сухой|Комната 2|
```
Здесь:
- `Кошка →→ Вид корма` (многозначная зависимость: Муся ест и влажный, и сухой корм);
    
- `Кошка →→ Комната` (Муся может находиться и в Комнате 1, и в Комнате 2);
    
- обе зависят **независимо** друг от друга от кошки.

Такое отношение **не соответствует 4НФ** — появляются избыточные записи и логические аномалии.

Разделим таблицу:
**Кошка — Вид корма:**
```
|Кошка|Вид корма|
|---|---|
|Муся|Влажный|
|Муся|Сухой|
```
Кошка — Комната:
```
|Кошка|Комната|
|---|---|
|Муся|Комната 1|
|Муся|Комната 2|
```
Теперь каждая таблица содержит только **одну независимую многозначную зависимость**, что соответствует 4НФ.

### Пятая нормальная форма (5НФ)
Отношение находится в **5НФ**, если оно:
- уже в 4НФ,
    
- и **не содержит зависимых соединений**, т.е. информацию нельзя разделить и потом корректно собрать только через pairwise-join.

В приюте работают:
- **Уходовцы** (сотрудники, ухаживающие за кошками),
    
- **Кошки**,
    
- **Вид процедур** (например, «чистка ушей», «стрижка когтей»).

Предположим, что:
- сотрудник может ухаживать за разными кошками,
    
- каждая кошка нуждается в разных процедурах,
    
- каждый сотрудник умеет выполнять определённые процедуры.
```
|Уходовец|Кошка|Процедура|
|---|---|---|
|Анна|Муся|Чистка ушей|
|Анна|Муся|Стрижка когтей|
|Анна|Рыжик|Чистка ушей|
|Иван|Муся|Чистка ушей|
```
Проблема: сложно определить, какие комбинации **Уходовец—Кошка—Процедура** допустимы. При добавлении новой процедуры может потребоваться добавить кучу строк вручную, и легко внести неконсистентность.

#### Приведение к 5НФ:

Разбиваем на три отношения:
1. **Уходовец — Кошка**
```
|Уходовец|Кошка|
|---|---|
|Анна|Муся|
|Анна|Рыжик|
|Иван|Муся|
```
2. Кошка — Процедура
```
|Кошка|Процедура|
|---|---|
|Муся|Чистка ушей|
|Муся|Стрижка когтей|
|Рыжик|Чистка ушей|
```
3. Уходовец — Процедура
```
|Уходовец|Процедура|
|---|---|
|Анна|Чистка ушей|
|Анна|Стрижка когтей|
|Иван|Чистка ушей|
```
Теперь при соединении трёх таблиц можно корректно восстановить допустимые комбинации.

### Доменно-ключевая нормальная форма (ДКНФ)
**Определение:**  
Отношение находится в **ДКНФ**, если **все ограничения**, наложенные на данные, можно выразить **только через ограничения ключей и доменов**.
#### Ограничения:
- **Домен** — тип значения (например, «Имя кошки» — строка, «Возраст» — целое число от 0 до 25).
    
- **Ключ** — уникальное множество атрибутов (например, {Кличка, Приют}).

Таблица кошек:
```
|Кличка|Возраст|Приют|
|---|---|---|
|Муся|5|Лапка|
|Рыжик|3|Хвостик|
```
Ограничения:
- Возраст — целое число от 0 до 25 (ограничение домена),
    
- Пара {Кличка, Приют} — уникальна (ограничение ключа).

Если все правила, применимые к таблице, можно выразить только так, то она в **ДКНФ**.

**На практике:**  
ДКНФ **крайне трудна** для достижения, особенно если нужно учитывать сложные бизнес-правила, ограничения между таблицами, процедуры, политики доступа и т. п.

## Шестая нормальная форма (6НФ)

**Определение:**  
Отношение находится в **6НФ**, если **не существует ни одной нетривиальной зависимости соединения**, т.е. оно **не может быть декомпозировано без потерь**.

**Другими словами:** это максимальная степень разбиения отношения, при которой **каждый факт** представлен **отдельной строкой**, **по одному атрибуту (кроме ключей и времени)**.

6НФ особенно полезна:
- при работе с **временными (хронологическими) данными**,
    
- когда значения атрибутов **меняются независимо** друг от друга со временем.

Пусть в приюте для кошек фиксируются **временные данные**:
- какая кличка у кошки;
    
- какая у неё шерсть (длинная, короткая);
    
- и в каком помещении она содержится.

Эти свойства могут **меняться в разное время и независимо**.

#### Исходная таблица:
```
|ID|Период времени|Кличка|Шерсть|Помещение|
|---|---|---|---|---|
|001|01-01-2022 – 01-05-2022|Муся|короткая|Комната 1|
|001|02-05-2022 – 01-01-2023|Муся|длинная|Комната 1|
|001|02-01-2023 – 01-06-2023|Муся|длинная|Комната 2|
```
**Проблема:**  
Если кличка, шерсть и помещение меняются независимо, то их нужно выделить в **отдельные таблицы**, иначе мы будем дублировать информацию (например, «длинная шерсть» будет повторяться, даже если меняется только помещение).
### Приведение к 6НФ:
 **Клички кошек (временные):**
```
|ID|Период времени|Кличка|
|---|---|---|
|001|01-01-2022 – ∞|Муся|
```
_(Кличка не менялась, но в 6НФ она выделяется отдельно)_

 **Шерсть кошек (временная характеристика):**
```
 |ID|Период времени|Шерсть|
|---|---|---|
|001|01-01-2022 – 01-05-2022|короткая|
|001|02-05-2022 – ∞|длинная|
```

Размещение кошек (временное):
```
|ID|Период времени|Помещение|
|---|---|---|
|001|01-01-2022 – 01-01-2023|Комната 1|
|001|02-01-2023 – ∞|Комната 2|
```
### Восстановление исходного отношения:
Для восстановления исходной информации используется **временное естественное соединение (`U_JOIN`)** по:
- `ID`,
    
- совпадающему **пересечению периодов времени**.

### Когда нужна 6НФ?
- При ведении **истории изменений** по **каждому отдельному атрибуту**;
    
- Для **хронологических баз данных**, например:
    
    - учёт сотрудников (должность, адрес),
        
    - учёт животных (местоположение, состояние),
        
    - логирование состояний объектов.

### Замечание:
- **6НФ не применяется в обычных бизнес-приложениях** — слишком дробная структура.
    
- Её **используют в СУБД с поддержкой временных операций** (например, SQL:2011 Temporal Tables).
