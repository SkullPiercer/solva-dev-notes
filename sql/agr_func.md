## Что такое агрегатная функция?

**Агрегатная функция** — это функция, которая обрабатывает **несколько строк** и возвращает **одно итоговое значение**, например сумму, среднее или максимум.

Структура запроса с агрегатной функцией (SQL)
```
SELECT [поля_группировки, агрегатные_функции]
FROM имя_таблицы
GROUP BY поля_группировки;
```

Предположим, у нас есть таблица `Movies`, в которой хранятся жанры фильмов и их рейтинги. Мы хотим узнать средний рейтинг по каждому жанру:
```
SELECT genre, AVG(rating) AS avg_rating
FROM Movies
GROUP BY genre;

Результат:
|Жанр|Средний рейтинг|
|---|---|
|Драма|7.8|
|Комедия|6.4|
|Боевик|7.1|
```

Часто используемые агрегатные функции
```
|Функция|Что делает|
|---|---|
|`SUM(поле)`|Считает сумму всех значений в столбце|
|`AVG(поле)`|Вычисляет среднее арифметическое|
|`COUNT(поле)`|Подсчитывает количество непустых значений|
|`MIN(поле)`|Показывает минимальное значение|
|`MAX(поле)`|Показывает максимальное значение|
```
Примечание: агрегатные функции **игнорируют значения `NULL`**, за исключением `COUNT(*)`, которая считает **все строки**, даже если они содержат `NULL`.

Пример с `COUNT(*)`
```
SELECT COUNT(*) AS total_movies FROM Movies;
```
Покажет общее количество фильмов в таблице, даже если какие-то поля не заполнены.

### Подсчет количества товаров по категории и сортировка по убыванию

**Задача:** посчитать, сколько товаров относится к каждой категории, и отсортировать результат по убыванию.
```
SELECT category, COUNT(*) AS total_items
FROM Products
GROUP BY category
ORDER BY total_items DESC;

Результат:
|category|total_items|
|---|---|
|Electronics|45|
|Furniture|32|
|Clothing|18|
```
Здесь:
- `COUNT(*)` подсчитывает количество строк в каждой группе,
    
- `GROUP BY category` группирует товары по категории,
    
- `ORDER BY total_items DESC` упорядочивает группы от самой многочисленной к наименьшей.

### Самая поздняя дата завершения аренды по каждому клиенту

**Задача:** для каждого клиента получить последнюю дату окончания аренды.
```
SELECT customer_id, MAX(end_date) AS last_rental
FROM Rentals
GROUP BY customer_id;

Результат:
|customer_id|last_rental|
|---|---|
|101|2023-11-10 15:00:00|
|102|2024-01-22 10:30:00|
|103|2023-12-05 17:00:00|
```
Здесь:
- `MAX(end_date)` выбирает наиболее позднюю дату завершения аренды,
    
- `GROUP BY customer_id` агрегирует записи по клиенту.
